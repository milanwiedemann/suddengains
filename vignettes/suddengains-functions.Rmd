---
title: "Using the suddengains R package to analyse sudden gains"
author: 
  - name: "Milan Wiedemann"
  - name: "Graham R Thew"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{An example using the suddengains R package to analyse sudden gains}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: ["references.bib", "r-references.bib"]
link-citations: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r packages, include = FALSE}
# Load packages
library(suddengains)
library(tidyverse)
library(knitr)
library(DT)
```
    

# Introduction

This vignette shows how the suddengains R package can be used to help with the methodology of a research study looking at sudden gains as described by @Tang1999.
More about the theoretical background of this package and why it might be helpful can be found in our preprint XXX.

# Data

Below are two interactive tables of the depression symptoms and rumination scores from the data set (`sgdata`) that comes with the `suddengains` package.

## Depression symptoms

```{r data-bdi, echo = FALSE}

sgdata_bdi <- sgdata %>% 
    select(id, 
           bdi_s0:bdi_s12, 
           bdi_fu1:bdi_fu2
           )
    
datatable(sgdata_bdi,
          rownames = FALSE,
          extensions = 'FixedColumns',
          options = list(
              pageLength = 5,
              scrollX = TRUE,
              fixedColumns = TRUE
              )
          )
```

## Rumination 

```{r data-rq, echo = FALSE}

sgdata_rq <- sgdata %>% 
    select(id, 
           rq_s0:rq_s12, 
           rq_fu1:rq_fu2
           )
    
datatable(sgdata_rq,
          rownames = FALSE,
          extensions = 'FixedColumns',
          options = list(
              pageLength = 5,
              scrollX = TRUE,
              fixedColumns = TRUE
              )
          )
```

# Select cases

The package offers two methods to select cases for the sudden gains studies.

1. `"pattern"`: cases providing enough data to apply the @Tang1999 criteria will be selected
1. `"min_sess"`: cases with a minimum number of available data (specified in `min_sess_num`) will be selected

```{r select, eval = FALSE}
# 1. method = "pattern"
select_cases(data = sgdata,
             id_var_name = "id",
             sg_var_list = c("bdi_s1", "bdi_s2", "bdi_s3", "bdi_s4", 
                             "bdi_s5", "bdi_s6", "bdi_s7", "bdi_s8", 
                             "bdi_s9", "bdi_s10", "bdi_s11", "bdi_s12"),
             method = "pattern",
             return_id_lgl = FALSE)

# 2. method = "min_sess"
select_cases(data = sgdata,
             id_var_name = "id",
             sg_var_list = c("bdi_s1", "bdi_s2", "bdi_s3", "bdi_s4", 
                             "bdi_s5", "bdi_s6", "bdi_s7", "bdi_s8", 
                             "bdi_s9", "bdi_s10", "bdi_s11", "bdi_s12"),
             method = "min_sess",
             min_sess_num = 9,
             return_id_lgl = TRUE)
```

The following code shows how to select cases based on the `"pattern"` method and save them as an object called `sgdata_select`.

```{r}
sgdata_select <- select_cases(data = sgdata,
                              id_var_name = "id",
                              sg_var_list = c("bdi_s1", "bdi_s2", "bdi_s3", "bdi_s4", 
                                              "bdi_s5", "bdi_s6", "bdi_s7", "bdi_s8", 
                                             "bdi_s9", "bdi_s10", "bdi_s11", "bdi_s12"),
                              method = "pattern",
                              return_id_lgl = FALSE) %>% 
                 filter(sg_select == TRUE)
```

The `count_intervals` function provides a summary of between session intervals that were and weren't analysed for sudden gains.
For more info see the help file of this function.

```{r}
count_intervals(data = sgdata_select,
                id_var_name = "id",
                sg_var_list = c("bdi_s1", "bdi_s2", "bdi_s3", "bdi_s4", 
                                "bdi_s5", "bdi_s6", "bdi_s7", "bdi_s8", 
                                "bdi_s9", "bdi_s10", "bdi_s11", "bdi_s12"),
                identify_sg_1to2 = FALSE)
```

# Define cut-off

```{r}
# Test define_crit1_cutoff function ----
define_crit1_cutoff(data_sessions = sgdata,
                    data_item = NULL,
                    tx_start_var_name = "bdi_s0",
                    tx_end_var_name = "bdi_s12",
                    reliability = 0.9)

```

# Identify sudden gains and losses

To simply identify sudden gains/losses you can use the `identify_sg` and `identify_sl` functions.
The functions return a data frame indicating for each between session interval whether a sudden gain/loss was identified.

```{r, eval = FALSE}
identify_sg(data = sgdata,
            sg_crit1_cutoff = 7,
            id_var_name = "id",
            sg_var_list = c("bdi_s1", "bdi_s2", "bdi_s3", "bdi_s4", 
                            "bdi_s5", "bdi_s6", "bdi_s7", "bdi_s8", 
                            "bdi_s9", "bdi_s10", "bdi_s11", "bdi_s12"),
            identify_sg_1to2 = FALSE
            )

```

To analyse sudden gains after the first session, we included the option to specify a baseline measure in `sg_var_list` (in this example `"bdi_s0"`) and set `identify_sg_1to2 == TRUE`.
This will allow to identify sudden gains after session 1, provided data from the baseline measure and the first session are available.

```{r, eval = FALSE}
identify_sg(data = sgdata,
            sg_crit1_cutoff = 7,
            id_var_name = "id",
            sg_var_list = c("bdi_s0", 
                            "bdi_s1", "bdi_s2", "bdi_s3", "bdi_s4", 
                            "bdi_s5", "bdi_s6", "bdi_s7", "bdi_s8", 
                            "bdi_s9", "bdi_s10", "bdi_s11", "bdi_s12"),
            identify_sg_1to2 = TRUE
            )
```

To identify sudden losses, you can use the `identify_sl` function.
All arguments are the same as in the `identif_ysg` function, but the `sg_crit1_cutoff` has to be set to be a negative value.

```{r, eval = FALSE}
identify_sl(data = sgdata,
            sg_crit1_cutoff = -7,
            sg_crit2_pct = .25,
            id_var_name = "id",
            sg_var_list = c("bdi_s1", "bdi_s2", "bdi_s3", "bdi_s4", 
                            "bdi_s5", "bdi_s6", "bdi_s7", "bdi_s8", 
                            "bdi_s9", "bdi_s10", "bdi_s11", "bdi_s12")
            )
```

# Create datasets

## All gains: One row per gain
In the suddengains R package we refer to this as "bysg" (by sudden gain).

Here we see code to create a "bysg" data set identifying sudden gains (specified using the argument `identify = "sg"`) and save it to the object called "bysl".
The following table shows the output.

```{r}
bysg <- create_bysg(data = sgdata,
                    sg_crit1_cutoff = 7,
                    id_var_name = "id",
                    tx_start_var_name = "bdi_s1",
                    tx_end_var_name = "bdi_s12",
                    sg_var_list = c("bdi_s1", "bdi_s2", "bdi_s3", "bdi_s4", 
                                    "bdi_s5", "bdi_s6", "bdi_s7", "bdi_s8", 
                                    "bdi_s9", "bdi_s10", "bdi_s11", "bdi_s12"),
                    sg_var_name = "bdi",
                    identify = "sg")
```


```{r, echo = FALSE}
datatable(bysg,
          rownames = FALSE,
          extensions = 'FixedColumns',
          options = list(
              pageLength = 5,
              scrollX = TRUE,
              fixedColumns = TRUE
              )
          )
```

Here we see code to create a "bysg" data set identifying sudden losses (specified using the argument `identify = "sl"`) and save it to the object called "bysl".
The following table shows the output.

```{r}
bysl <- create_bysg(data = sgdata,
                    sg_crit1_cutoff = -7,
                    id_var_name = "id",
                    tx_start_var_name = "bdi_s1",
                    tx_end_var_name = "bdi_s12",
                    sg_var_list = c("bdi_s1", "bdi_s2", "bdi_s3", "bdi_s4", 
                                    "bdi_s5", "bdi_s6", "bdi_s7", "bdi_s8", 
                                    "bdi_s9", "bdi_s10", "bdi_s11", "bdi_s12"),
                    sg_var_name = "bdi",
                    identify = "sl")
```


```{r, echo = FALSE}
datatable(bysl,
          rownames = FALSE,
          extensions = 'FixedColumns',
          options = list(
              pageLength = 5,
              scrollX = TRUE,
              fixedColumns = TRUE
              )
          )
```



## All cases: One row per case

In the suddengains R package we refer to this as byperson (by person).
This data set includes all cases with and all cases without sudden gains.
If multiple sudden gains were experienced by a cases, the argument `multiple_sg_select = "first"` can be used to specify which gain to select, in this case the first. 

```{r}
byperson_first <- create_byperson(data = sgdata,
                                  sg_crit1_cutoff = 7,
                                  id_var_name = "id",
                                  tx_start_var_name = "bdi_s1",
                                  tx_end_var_name = "bdi_s12",
                                  sg_var_list = c("bdi_s1", "bdi_s2", "bdi_s3", "bdi_s4", 
                                                  "bdi_s5", "bdi_s6", "bdi_s7", "bdi_s8", 
                                                  "bdi_s9", "bdi_s10", "bdi_s11", "bdi_s12"),
                                  sg_var_name = "bdi",
                                  identify_sg_1to2 = FALSE,
                                  multiple_sg_select = "first"
                                  )
```

```{r, echo = FALSE}
datatable(byperson_first,
          rownames = FALSE,
          extensions = 'FixedColumns',
          options = list(
              pageLength = 5,
              scrollX = TRUE,
              fixedColumns = TRUE
              )
          )
```

```{r}
byperson_largest <- create_byperson(data = sgdata,
                                    sg_crit1_cutoff = 7,
                                    id_var_name = "id",
                                    tx_start_var_name = "bdi_s1",
                                    tx_end_var_name = "bdi_s12",
                                    sg_var_list = c("bdi_s1", "bdi_s2", "bdi_s3", "bdi_s4", 
                                                    "bdi_s5", "bdi_s6", "bdi_s7", "bdi_s8", 
                                                    "bdi_s9", "bdi_s10", "bdi_s11", "bdi_s12"),
                                    sg_var_name = "bdi",
                                    identify_sg_1to2 = FALSE,
                                    multiple_sg_select = "largest"
                                    )
```

```{r, echo = FALSE}
datatable(byperson_largest,
          rownames = FALSE,
          extensions = 'FixedColumns',
          options = list(
              pageLength = 5,
              scrollX = TRUE,
              fixedColumns = TRUE
              )
          )
```

# Extract values around sudden gains

```{r}
# For bysg dataset select rq variables first
sgdata_rq <- sgdata %>% 
    select(id, rq_s0:rq_s12)

# Join them
bysg_rq <- bysg %>%
    left_join(sgdata_rq, by = "id")

# Extract scores for bysg dataset
bysg_rq <- extract_values(data = bysg_rq,
                          id_var_name = "id_sg",
                          extract_var_list = c("rq_s1", "rq_s2", "rq_s3", "rq_s4", 
                                               "rq_s5", "rq_s6", "rq_s7", "rq_s8", 
                                               "rq_s9", "rq_s10", "rq_s11", "rq_s12"),
                          extract_var_name = "rq",
                          add_to_data = TRUE
                          )
```

```{r, echo = FALSE}
datatable(bysg_rq,
          rownames = FALSE,
          extensions = 'FixedColumns',
          options = list(
              pageLength = 5,
              scrollX = TRUE,
              fixedColumns = TRUE
              )
          )
```

# Plots of average change around sudden gains

## Depression symptoms

```{r}
plot_sg_bdi <- plot_sg(data = bysg,
                       tx_start_var_name = "bdi_s1",
                       tx_end_var_name = "bdi_s12",
                       sg_pre_post_var_list = c("sg_bdi_2n", "sg_bdi_1n", "sg_bdi_n",
                                                "sg_bdi_n1", "sg_bdi_n2", "sg_bdi_n3"),
                       ylab = "BDI", xlab = "Session")

plot_sg_bdi
```

## A secondary outcome or process measure

```{r}
plot_sg_rq <- plot_sg(data = bysg_rq,
                       tx_start_var_name = "rq_s1",
                       tx_end_var_name = "rq_s12",
                       sg_pre_post_var_list = c("sg_rq_2n", "sg_rq_1n", "sg_rq_n",
                                                "sg_rq_n1", "sg_rq_n2", "sg_rq_n3"),
                       ylab = "RQ", xlab = "Session")

plot_sg_rq
```

# Summarise some descriptive statistics

# References
